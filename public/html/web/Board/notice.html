

<include>_header_info.html</include>
<script>window.service.session.checkSession();</script>
<include>navi.html</include>
<style>
#container{
	left: 0px !important; right: 0px !important; bottom: 0px !important; top: 0px !important;
}
#content{
	left: 0px !important; right: 0px !important; bottom: 0px !important; top: 0px !important;
}
#list{
	margin : 0px !important;border-bottom : 1px solid rgba(34, 36, 38, 0.15) !important;
}
#list:last-child{
	margin : 0px !important;border-bottom : 0 !important;
}

.bottom_line{
	margin : 0px !important;border-bottom : 1px solid rgba(34, 36, 38, 0.15) !important;
}

</style>
<!-- <div class="ui centered grid">
	<div class="twelve wide column pad_t_60 pad_b_60"> -->

	<!----- contents ----->


	<div id="container" class="ui container">
		<!-- 2 -->
		<div class="ui horizontal segments" style="left: 0px !important; right: 0px !important; bottom: 0px !important; top: 0px !important; position: absolute; margin: 0px;">

			<!-- 3 -->
			<div id="div-PIMS-menu-list" class="ui vertical menu segment" style="padding : 0px; min-width: 270px !important; max-width: 270px !important; overflow-y: auto !important;">

				<a class="item" href="#"><h4>TESTServer</h4></a>
				<a class="item" href="#">notebook1</a>
				<a class="item" href="#">notebook2</a>
				<a class="item" href="#">notebook3</a>
				<a class="item" href="#">notebook4</a>
				<a class="item" href="#">notebook5</a>


				<!--
				depth 구조의 메뉴바 구현 example;
				<div class="item">
					<div class="header">menu1</div>
					<div class="div_menu menu">
						<div class="item">test1</div>
					</div>
					<div class="div_menu menu">
						<div class="item">test1</div>
					</div>
				</div>
				-->
			</div>
			<div id="div-PIMS-VerticalContainer" class="ui fluid basic segment" style="min-height: auto !important; max-height: auto !important;overflow-y : hidden !important;">

				<div id="div-PIMS-GridContainer" class="ui grid" style="height : auto !important;">
					<div id="div-PIMS-HeaderContainer"class="sixteen wide fixed column" style="background-color : #eeeeee;">
						<div class="ui red horizontal label">Notice!</div>알파 서비스 0.1.0 버전 입니다.추가 요구 사항은 개발팀에 문의 바랍니다.
					</div>
					<div class="sixteen wide column" id="div-PIMS-headerContainer" style="width: 100%;border-bottom : 1px solid rgba(34, 36, 38, 0.15) !important;">
						<h3 class="div_sub_header sub header">{{menu_name}}</h3>
					</div>
					<div class="sixteen wide column" id="div-PIMS-ViewContainer" style="min-height: 808px !important;">

						<div class="ui grid">
							<div class="four wide column" style="border-right : 1px solid rgba(34, 36, 38, 0.15) !important;padding : 0px !important;overflow-y: auto !important; min-height: 808px !important;height: 808px !important;" id="sub_list">
								<!-- <div id="list" class="ui basic segment item">
									<h4>제목입니다.</h4>
									<p>본문요약입니다.</p>
								</div>
								<div id="list" class="ui basic segment item">
									<h4>제목입니다.</h4>
									<p>본문요약입니다.</p>
								</div>
								<div id="list" class="ui basic segment item">
									<h4>제목입니다.</h4>
									<p>본문요약입니다.</p>
								</div> -->
							</div>


							<div class="twelve wide column" style="overflow-y: auto !important;padding : 0px !important;overflow-y: auto !important; max-height: 808px !important;">

								<div style="position:fixed;right :30px;bottom : 60px; z-index : 102;">

										<div class="ui buttons">
											<button class="ui button" id="add" style="display : block;">글쓰기</button>
	  									  <button class="ui button" id="modify" style="display : none;">수정</button>
	  									  <button class="ui button" id="delete" style="display : none;">삭제</button>
	  									  <button class="ui button" id="cancel" style="display : none;">취소</button>
	  									  <button class="ui button" id="lists" style="display : none;">목록</button>
	  									  <button class="ui button" id="write" style="display : none;">등록</button>

										</div>

								</div>

								<div class="ui basic segment" id="view_container">
								</div>
							</div>
						</div>



					</div>
					<div id="div-PIMS-FooterContainer" class="sixteen wide column"style="background-color : #eeeeee; bottom : 0px !important;position : relative !important;border-top : 1px solid rgba(34, 36, 38, 0.15) !important;">Copyright © B2LABS All Rights Reserved.</div>
				</div>

			</div>
		</div>
	</div>
	<!----- contents ----->

	<!-- </div>
</div> -->

<include>_footer_info.html</include>
<script type="text/javascript">

//editor 라이브러리 로드;
var sNew = document.createElement("script");
sNew.async = true;
sNew.src = "libs/ckeditor/ckeditor.js";
var s0 = document.getElementsByTagName('script')[0];
s0.parentNode.insertBefore(sNew, s0);
//editor 라이브러리 로드;

//--------------------------------------------------variable;
var list_data = "";
var current_view_doc__id = -1;

//------------------------------_el;
var _el_input__title = document.getElementById("title");
var _el_div__view_container = document.getElementById("view_container");
var _el_div__add_doc_con = document.getElementById('add_doc_con');
var _el_div__view_document =  document.getElementById('view_document');
//------------------------------_el;

//--------------------------------------------------variable;

/*
	//ToDo 정리해야할 함수;
	function htmlEntities(str) {
	    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
	}

	function htmlEntities3(str) {
	    return String(str).replace(/(\S+)=["']?((?:.(?!["']?\s+(?:\S+)=|[>"']))+.)["']?/g, '')
		.replace(/^<table.*[">$]/g, '<table class="ui celled table">')
		.replace(/<span >/g, '')
		.replace(/<\/span>/g, '')
		.replace(/<td >/g, '<td>')
		.replace(/&nbsp;/g, '')
	//	.replace(//g, '<td>')
	}
*/

//--------------------------------------------------function;
/**
*
*/
var htmlEntities =  function(str){
	return String(str).replace(/&quot;/g, '"')
	.replace(/%/g, '%25')
	//.replace(/^<table.*[">$]/g, '<table class="ui celled table">')
	.replace(/&nbsp;/g, '')
	.replace(/\r/g, '')
	.replace(/\n/g, '')
	.replace(/\t/g, '')
};
/**
*
*/
var make_Array_dateFormat = function( arr ){
	return arr[ 0 ] + "."+ arr[ 1 ] + "."+ arr[ 2 ] + " "+ arr[ 3 ] + ":"+ arr[ 4 ] + ":"+ arr[ 5 ];
}
//--------------------------------------------------function;

/**
*문서를 등록한다.
*/
var write_doc = function(){

	var url = "/api/Board/write"
	var title = _el__input_title.value
	var data = "sid=" + window.service.cookie.getCookie('session')
			+ "&data=" + htmlEntities( CKEDITOR.instances.editor.getData() )
			+ "&title=" + title;

	window.service.Request.req_POST_data__Callback(url,data,function( result ){
		if(result == 0){
			window.service.session.remove_deleteCookies()
			location.href = "/Member/login";
		}

		var data = JSON.parse( result );
		console.log( data );
		console.log( "--등록완료--" );

		_el_div__view_container.removeChild( _el_div__add_doc_con );

		make_sub_list();//서브리스트 갱신;
		req_detail_by__id( data._id );//view 데이터 갱신;
	})
}

/**
* 리스트의 문서디테일을 가져와 화면에 그린다.
*/
var req_detail_by__id = function( _id ){
	var url = "/api/Board/detail_view_by__id?sid=" + window.service.cookie.getCookie('session') + "&_id=" + _id
	if( _el_div__add_doc_con )
	{
		 _el_div__view_container.removeChild( _el_div__add_doc_con );
	}
	window.service.Request.req_GET_data__Callback(url,function(result){
		if(result == 0){
			window.service.session.remove_deleteCookies()
			location.href = "/Member/login";
		}
		var data = JSON.parse( result );

		console.log( data );
		current_view_doc__id = data[ 0 ]._id;

		var regist_date = make_Array_dateFormat( data[ 0 ].regist_date );
		var title = data[ 0 ].title
		var content = data[ 0 ].content

		if( !_el_div__view_document ){

			var div_content = document.createElement("div")
				div_content.setAttribute("class","ui basic segment item")
				div_content.setAttribute("id","view_document")

			var div0 = document.createElement("div")
				div0.setAttribute("class", "ui basic segment item");

			var h2 = document.createElement("h2")
				h2.setAttribute("id", "view_document_title");
			var h2_text = document.createTextNode( title );

			var p = document.createElement("p")
				p.setAttribute("id", "view_document_date");
			var p_text = document.createTextNode( regist_date );

			var div1 = document.createElement("div")
				div1.setAttribute("class", "ui basic segment");
				div1.setAttribute("id", "view_document_content");
				div1.innerHTML = content;

			h2.appendChild( h2_text );
			p.appendChild( p_text )
			div0.appendChild( h2 );
			div0.appendChild( p );
			div_content.appendChild( div0 );
			div_content.appendChild( div1 );

			_el_div__view_container.appendChild( div_content )

		}else{
			document.getElementById( "view_document_title" ).innerHTML = title
			document.getElementById( "view_document_date" ).innerHTML = regist_date
			document.getElementById( "view_document_content" ).innerHTML = content
		}

		if( document.getElementById('add_doc_con') ) document.getElementById('add_doc_con').innerHTML = ""
		document.getElementById('view_document').style.display = "block"
		//---------- Button;
		document.getElementById("add").style.display = "block";
		document.getElementById("modify").style.display = "block";
		document.getElementById("delete").style.display = "block";
		document.getElementById("cancel").style.display = "none";
		document.getElementById("lists").style.display = "none";
		document.getElementById("write").style.display = "none";
		//---------- Button;

		document.getElementById("modify").removeEventListener("click",update_doc)
		document.getElementById("modify").addEventListener("click",modify_doc)

	})

}


var make_sub_list = function(){

	//window.service.message.toaster("hello! " + window.service.cookie.getCookie('mid'))
	//alertify.alert("hello! " + window.service.cookie.getCookie('mid'));

	var _t0 = document.getElementById('sub_list')
	var url = "/api/Board/get_list?sid=" + window.service.cookie.getCookie('session')

	window.service.Request.req_GET_data__Callback(url,function(result){
		if(result == 0){
			window.service.session.remove_deleteCookies()
			location.href = "/Member/login";
		}
		var data = JSON.parse( result )

		_t0.innerHTML = "";
		var i = 0,iLen = data.length,io;
		for(; i<iLen; ++i ){

			io = data[ i ];
			var div0 = document.createElement("div")
				div0.setAttribute("id", "list");
				div0.setAttribute("class", "ui basic segment item bottom_line");
				div0.setAttribute("idx", io._id);

			var h4 = document.createElement("h4")
			var h4_text = document.createTextNode( io.title );

			var div__id = document.createElement("div")
				div__id.setAttribute("id", "list_id");
				div__id.setAttribute("style", "display : none;");
			var div__id_text = document.createTextNode( io._id )

			div__id.appendChild( div__id_text );

			h4.appendChild( h4_text );

			var div1 = document.createElement("div")
				div1.setAttribute("id", "sub_list_date");
				div1.setAttribute("class", "pad_b_10");

			var regist_date = io.regist_date[ 0 ] + "."
			+ io.regist_date[ 1 ] + "."
			+ io.regist_date[ 2 ]+ " "
			+ io.regist_date[ 3 ] + ":"
			+ io.regist_date[ 4 ]+ ":"
			+ io.regist_date[ 5 ]

			var div1_text = document.createTextNode( regist_date );

			div1.appendChild( div1_text );

			div0.appendChild( div__id )
			div0.appendChild( h4 )
			div0.appendChild( div1 )

			_t0.appendChild( div0 )
		}

		var check_dom = function( e, str ){
			if( e.getAttribute("id") == str ) return e
			else if( e.getAttribute("id") == "sub_list" ) return "";
			else return check_dom( e.parentElement, "list" )
		}

		_t0.addEventListener("click",function(e){
			//console.log(e.currentTarget.children[0].innerText)
			var pe = e.currentTarget.children
			var k = check_dom( e.target, "list" )

			var i = 0,iLen = pe.length,io;
			for(;i < iLen;++i){
				io = pe[ i ]
				if( io == k ){
					console.log( i )
					req_detail_by__id( list_data[ i ]._id )
				}
			}

		})
		list_data = data;
	})

}



   var _el_add = document.getElementById("add");
   var _el_modify = document.getElementById("modify");
   var _el_view = document.getElementById("view");
   var _el_view_container = document.getElementById("view_container");
   var _el_view_document = document.getElementById("view_document");


   var _el_all_addEvent = function(){

    _el_add.addEventListener("click",add_doc)
	_el_modify.addEventListener("click",modify_doc)

    // _el_view.addEventListener("click",view_doc )
   }

   var view_container_all_el_display_none = function(){
	   var i = 0,iLen = _el_view_container.children.length,io;
	   for(;i<iLen;++i){
		   io = _el_view_container.children[ i ]
		   io.style.display = "none";
	   }
   }

   // var cancel_doc = function(){
   //  view_container_all_el_display_none()
   //  view_doc();
   // }


	var view_doc = function(){
	   view_container_all_el_display_none();
	   _el_view_document.setAttribute("style","display : block;")
	   _el_all_addEvent();
	}

	var update_doc = function( data ){

		function htmlEntities(str) {
		    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
		}

		function htmlEntities2(str) {
		    return String(str).replace(/&quot;/g, '"')
			.replace(/%/g, '%25')
			//.replace(/^<table.*[">$]/g, '<table class="ui celled table">')
			.replace(/&nbsp;/g, '')
			.replace(/\r/g, '')
			.replace(/\n/g, '')
			.replace(/\t/g, '')
		}

		function htmlEntities3(str) {
		    return String(str).replace(/(\S+)=["']?((?:.(?!["']?\s+(?:\S+)=|[>"']))+.)["']?/g, '')
			.replace(/^<table.*[">$]/g, '<table class="ui celled table">')
			.replace(/<span >/g, '')
			.replace(/<\/span>/g, '')
			.replace(/<td >/g, '<td>')
			.replace(/&nbsp;/g, '')
		//	.replace(//g, '<td>')
		}


		var url = "/api/Board/update"
		debugger;
		var title = document.getElementById("title").value
		var data = "sid=" + window.service.cookie.getCookie('session')
		+ "&_id=" + current_view_doc__id
		+ "&data=" + htmlEntities2(CKEDITOR.instances.editor.getData())
		+ "&title=" + title;

		window.service.Request.req_POST_data__Callback(url,data,function( result){
			if(result == 0){
				window.service.session.remove_deleteCookies()
				location.href = "/Member/login";
			}
			var data = JSON.parse( result )

			console.log( data )
			console.log( "--등록완료--" )

			// //<div class="ui basic segment item" id="view_document_title"></div>
			// //<div class="ui basic segment" id="view_document_content"></div>
			//
			// document.getElementById( "view_document_title" ).innerHTML = data[ 0 ].title
			// document.getElementById( "view_document_content" ).innerHTML = data[ 0 ].content
			debugger;
			document.getElementById("view_container").removeChild(document.getElementById("add_doc_con"));

			make_sub_list();
			req_detail_by__id( data )

		})

	}

	var write_cancel = function(){

		//Dom 삭제;
		document.getElementById("view_container").removeChild(document.getElementById("add_doc_con"));

		//에디터초기화;
		//CKEDITOR.instances.editor.destroy();

		//----------;
		document.getElementById("add").style.display = "block";
		document.getElementById("modify").style.display = "none";
		document.getElementById("delete").style.display = "none";
		document.getElementById("cancel").style.display = "none";
		document.getElementById("lists").style.display = "none";
		document.getElementById("write").style.display = "none";
		//----------;

	}


	var modify_doc = function(){
		//view_container_all_el_display_none();
		add_doc();

		document.getElementById("title").value = document.getElementById("view_document_title").innerText;
		CKEDITOR.instances.editor.setData( document.getElementById("view_document_content").innerHTML );
		//_el_add.removeEventListener( "click", add_doc )
		//----------;
		document.getElementById("add").style.display = "none";
		document.getElementById("modify").style.display = "block";
		document.getElementById("delete").style.display = "none";
		document.getElementById("cancel").style.display = "block";
		document.getElementById("lists").style.display = "none";
		document.getElementById("write").style.display = "none";
		//----------;

		document.getElementById("modify").removeEventListener("click",modify_doc)
		document.getElementById("modify").addEventListener("click",update_doc)

		//document.getElementById("write").addEventListener("click",write_doc)

	}

   var delete_doc = function(){

   }

	var add_doc = function(){
		//view_container_all_el_display_none();
		if( document.getElementById( "view_document" ) ) document.getElementById( "view_document" ).setAttribute("style","display : none;");
		//if( document.getElementById("add_doc_con") == null ){

		var div_con =  document.createElement("div");
			div_con.setAttribute("id", "add_doc_con");

		var div0 = document.createElement("div")
			div0.setAttribute("class", "ui fluid icon input");
			div0.setAttribute("style", "margin-bottom : 14px;");

		var input = document.createElement("input")
			input.setAttribute("type", "text");
			input.setAttribute("placeholder", "제목을 입력하세요");
			input.setAttribute("id", "title");

		div0.appendChild( input )

		var textarea = document.createElement("textarea")
			textarea.setAttribute("class", "ckeditor");
			textarea.setAttribute("rows", "10");
			textarea.setAttribute("name", "contents");
			textarea.setAttribute("id", "editor");
			textarea.setAttribute("style", "display : none;");

		div_con.appendChild( div0 );
		div_con.appendChild( textarea );

		_el_view_container.appendChild( div_con );


		CKEDITOR.replace( 'contents',{
			customConfig : './config.js',
			width: '100%',
			height: '600px',
			toolbarStartupExpanded : false
		});

	// }else{
	// 	// document.getElementById("add_doc_con").style.display = "block";
	//
	// }

	document.getElementById("title").value = "";
	CKEDITOR.instances.editor.setData("내용을 입력해주세요")

	//----------;
	document.getElementById("add").style.display = "none";
	document.getElementById("modify").style.display = "none";
	document.getElementById("delete").style.display = "none";
	document.getElementById("cancel").style.display = "block";
	document.getElementById("lists").style.display = "none";
	document.getElementById("write").style.display = "block";
	//----------;

	document.getElementById("write").addEventListener("click",write_doc)
	document.getElementById("cancel").addEventListener("click", write_cancel );

	}

var Initialize = function(){

	_el_all_addEvent();
	make_sub_list();

}

Initialize();

// window.addEventListener('click', function(e){
// 	var a = document.getElementById('view_document').contains(e.target)
// 	console.log( a )
// 	console.log( e.target)
// 	if ( document.getElementById('cke_editor').contains(e.target)){
//   	console.log(1)
//   } else{
// 	  var editorData = CKEDITOR.instances['editor'].getData();
// 	  document.getElementById('view_document').innerHTML = editorData;
// 	  console.log( 2 )
// 		view_doc();
//   }
// })

</script>
<script>
// window.service.render.dimmer( window.service.cookie.getCookie('mid') );
// //window.service.message.toaster("hello! " + window.service.cookie.getCookie('mid'))
// //alertify.alert("hello! " + window.service.cookie.getCookie('mid'));
//
// var _t0 = document.getElementById('data')
// var url = "/api/get_list?sid=" + window.service.cookie.getCookie('session')
//
// window.service.Request.req_GET_data__Callback(url,function(result){
// 	if(result == 0){
// 		window.service.session.remove_deleteCookies()
// 		location.href = "./login";
// 	}
// 	var data = JSON.parse( result )
// 	for(var i = 0; i < data.length; ++i){
//
// 		var tr = document.createElement("tr");
//
// 		for(var s in data[ i ]){
//
// 			var td = document.createElement("td")
// 			var text = document.createTextNode( data[ i ][ s ] );
// 			//console.log( text )
// 			td.appendChild(text)
// 			tr.appendChild(td)
// 		}
//
// 		_t0.append(tr)
//
// 	}
// })
</script>
