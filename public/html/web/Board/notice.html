<include>_header_info.html</include>
<include>navi.html</include>	
<include>header.html</include>

<link rel='stylesheet' type="text/css" href='/css/notice.css'>								
<!-- contents -->
<div class="ui grid">
	<div class="sixteen wide column" id="project_list_container" style="width: 100%;">
			<div class="ui basic segment">
				<div class="ui cards" id="project_list"></div>	
			</div>
	</div>
	<div class="sixteen wide column" style="border-right : 1px solid rgba(34, 36, 38, 0.15) !important;padding : 0px !important;overflow-y: auto !important; min-height: 848px !important;height: 848px !important;">
		<div id="app">
			<div class="ui left wide sidebar" id="project_side_bar">
				<div class="ui grid" style="margin : 0px;padding : 0px; background-color:#fff;overflow-y: hidden !important;">
					<div class="sixteen wide column" style="border-right : 1px solid rgba(34, 36, 38, 0.15) !important;padding : 0px !important;min-height: 848px !important;height: 848px !important;">
						<div id="notebook_add_container" class="ui basic segment item">
							<div class="ui grid">
								<!--project_list-->
								<div class="sixteen wide column" id="project_title_div" style="padding : 0px;">
									<div class="ui items">
										<div class="item" style="padding : 30px;margin : 0px;">
											<div class="content">
												<div class="header" id="project_title" style="max-width : 80%;"></div>
												<div class="ui right floated mini icon button" id="notebook_add"><i class="plus icon"></i></div>
												<div class="ui right floated mini icon button" id="project_title_modify_btn"><i class="file alternate icon"></i></div>
												<div class="description" id="project_desc"></div>
											</div>
										</div>
									</div>
								</div>
								<!--project_list-->
							</div>
						</div>
						<div class="ui items" id="notebook_list"></div>
					</div>
				</div>
			</div>
			<div class="ui right wide sidebar" id="file_side_bar">
				<div class="ui basic segment" id="chat_container" style="min-height : 848px;padding : 0px;border-right : 1px solid rgba(34, 36, 38, 0.15) !important;">
					<div class="item" style="padding : 0px !important">
						<div class="ui grid" style="margin : 0px !important;">
							<div class="sixteen wide column" id="doc_file_sidebar_header" style="line-height : 36px">Comment</div>
							<div class="sixteen wide column" id="doc_file_sidebar_container" style="min-height: 785px;max-height: 785px; height : 785px;">
								<div class="ui feed">
									<div class="event">
										<div class="label">
											<img src="https://semantic-ui.com/images/avatar/small/joe.jpg">
										</div>
										<div class="content">
											<div class="summary">
												<a class="user">Elliot Fu</a> added you as a friend
												<div class="date">1 Hour Ago</div>
											</div>
											<div class="meta">
												<a class="like">
													<i class="like icon"></i> 4 Likes
												</a>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="pusher" id="pusher_container" style="display:none;">
				<div class="ui grid container" style="padding:0px;margin:0px;">
					<div class="three wide column" style="border-right : 1px solid rgba(34, 36, 38, 0.15) !important;padding : 0px !important;min-height: 848px !important;height: 848px !important;">
						<div id="note_add_container" class="ui basic segment item" style="display : none;">
							<div class="ui grid">
								<div class="sixteen wide column" id="notebook_title_div"  style="padding : 0px;">
									<div class="ui items">
										<div class="item" style="padding : 30px;margin : 0px;">
											<div class="content">
												<div class="header" id="notebook_title" style="max-width : 80%;"></div>
												<div class="ui right floated mini icon button" id="note_add"><i class="plus icon"></i></div>
												<div class="ui right floated mini icon button" id="notebook_title_modify_btn"><i class="file alternate icon"></i></div>
												<div class="description" id="notebook_desc"></div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div id="sub_list"  class="ui items"></div>
					</div>
					<div class="ten wide column" style="border-right : 1px solid rgba(34, 36, 38, 0.15) !important;margin : 0px;overflow-y: auto !important;padding : 0px !important;overflow-y: auto !important; max-height: 848px !important;">
						<div class="ui basic segment" id="view_container" style="min-height : 745px;"></div>
						<div class="ui basic segment" style="margin : 0px">
							<div class="ui buttons">
								<button class="ui button" id="modify" style="display : none;">수정</button>
								<button class="ui button" id="delete" style="display : none;">삭제</button>
								<button class="ui button" id="cancel" style="display : none;">취소</button>
								<button class="ui button" id="lists" style="display : none;">목록</button>
								<button class="ui button" id="write" style="display : none;">등록</button>
							</div>
						</div>
					</div>
					<div class="three wide column" style="overflow-y: auto !important;padding : 0px !important;overflow-y: auto !important; max-height: 848px !important;">
						<div class="ui basic segment" id="chat_container" style="min-height : 848px;padding : 0px">
							<div class="item" style="padding : 0px !important">
								<div class="ui grid" style="margin : 0px !important;">
									<div class="sixteen wide column" id="comment_sidebar_header" style="line-height : 36px">Comment
											<div id="doc_chat_file_add_btn"style="float:right;cursor : pointer;"><i class="file alternate fitted icon"></i></div>
									</div>
									<div class="sixteen wide column" id="doc_comment_wrap" style="background-color : #fff;;min-height : 630px;max-height : 630px;overflow-y : auto;">
										<div class="ui comments" id="doc_comment_container"></div>
									</div>
									<div class="sixteen wide column" id="">
										<div class="ui form">
											<div class="field">
											<!--label>Short Text</label-->
											<textarea rows="2" id="doc_comment_textarea"></textarea>
											</div>
											<div class="field">	  
												<button class="ui button fluid" id="doc_comment_send_btn">send</button>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- contents -->
							
<include>footer.html</include>

<!--modal-->

<!-- 파일 추가 모달 -->
<div class="ui mini modal transition" id="doc_chat_file_add_modal">
		<div class="header">File Send</div>
		<div class="content">
			<div class="ui form">
				<div class="field">
					<div class="ui input">
						<input type="file"  id="doc_file_upload_input">
					</div>
				</div>
				<div class="field">
					<textarea rows="2" id="doc_file_textarea"></textarea>
				</div>
				<div class="field">
					<div class="ui bulleted list" id="upload_files"></div>
				</div>
				<div class="field">
					<button class="fluid ui positive button"  id="doc_file_add_send_btn">Send</button>
				</div>
			</div>
		</div>
	</div>
<!-- 파일 추가 모달 -->

<!-- 프로젝트 추가 모달 -->

<div class="ui mini modal transition" id="project_add_modal">
	<div class="header" id="modal_project_header"></div>
	<div class="content">
		<div class="ui form">
			<div class="field">
				<label>Project Name</label>
				<input type="text" name="projec-name" placeholder="Project Name" id="modal_project_nm">
			</div>
			<div class="field">
				<label>Description</label>
				<textarea id="modal_project_desc"></textarea>
			</div>
			<div class="field" id="project_add_write_field">
				<button class="green fluid ui button" id="project_add_write">Add</button>
			</div>
			<div class="field" id="project_update_btn_field">
				<button class="orange fluid ui button" id="project_update_btn">Modify</button>
			</div>
			<div class="field">
				<button class="fluid ui button"  id="project_add_cancel">Cancel</button>
			</div>
		</div>
	</div>
</div>

<!-- 프로젝트 추가 모달 -->

<!-- 노트북 추가 모달 -->

<div class="ui mini modal transition" id="notebook_add_modal">
	<div class="header">
		Notebook Add.
	</div>
	<div class="content">
		<div class="ui form">
			<div class="field">
				<label>Notebook Name</label>
				<input type="text" name="notebook-name" placeholder="Notebook Name" id="modal_notebook_nm">
			</div>
			<div class="field">
				<label>Description</label>
				<textarea id="modal_notebook_desc"></textarea>
			</div>
			<div class="field" id="notebook_add_write_field">
				<button class="green fluid ui button" id="notebook_add_write">Add</button>
			</div>
			<div class="field" id="notebook_update_btn_field">
				<button class="orange fluid ui button" id="notebook_update_btn">Modify</button>
			</div>
			<div class="field">
				<button class="fluid ui button" id="notebook_add_cancel">Cancel</button>
			</div>
		</div>
	</div>
</div>

<!-- 노트북 추가 모달 -->
<!--modal-->
<include>_footer_info.html</include>

<script type="text/javascript"> 
// secondary menu
// $('.secondary.menu .ui.sidebar')
//   .sidebar({ context: $('.bottom.segment') })
//   .sidebar('attach events', '.secondary.menu .item')
//   .sidebar('setting', 'transition', 'push')
//   .sidebar('setting', 'dimPage', false)

window.service.domStorage = {};

//editor 라이브러리 로드;
var sNew = document.createElement("script");
sNew.async = true;
sNew.src = "libs/ckeditor/ckeditor.js";
var s0 = document.getElementsByTagName('script')[0];
s0.parentNode.insertBefore(sNew, s0);
//editor 라이브러리 로드;

//--------------------------------------------------variable;
var notebook_detail_data = [];
var project_list_data = [];
var notebook_list_data = [];

var current_view_doc__data = {};
var current_project__data = {};
var current_notebook__data = {};
var current_note_chat__data = {};
var current_note_todo__data = {};

var pre_objDiv_scrollHeight = 0;
//--------------------------------------------------variable;

//------------------------------_el;
var _el_div__view_container = document.getElementById("view_container");
var _el_div__sub_list = document.getElementById('sub_list');
var _el_div__notebook_list = document.getElementById("notebook_list");
var _el_div__project_list = document.getElementById("project_list");
var _el_div__doc_comment_container = document.getElementById("doc_comment_container");

var _el_btn__notebook_add = document.getElementById( "notebook_add" );
var _el_btn__project_add_write = document.getElementById( "project_add_write" );
var _el_btn__project_add_cancel = document.getElementById( "project_add_cancel" );
var _el_btn__notebook_add_write = document.getElementById( "notebook_add_write" );
var _el_btn__notebook_add_cancel = document.getElementById( "notebook_add_cancel" );
var _el_btn__project_update_btn = document.getElementById("project_update_btn");
var _el_btn__notebook_title_modify_btn = document.getElementById("notebook_title_modify_btn");
var _el_btn__project_list_view_btn = document.getElementById("project_list_view_btn")
var _el_btn__doc_comment_send_btn = document.getElementById( "doc_comment_send_btn" );
var _el_btn__doc_chat_file_add_btn = document.getElementById( "doc_chat_file_add_btn" );

var el_doc_chat__file_input = document.getElementById("doc_file_upload_input");
var el_doc_chat__file_button = document.getElementById("doc_file_add_send_btn");

//------------------------------_el;
/*
	//ToDo 정리해야할 함수;
	function htmlEntities(str) {
	    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
	}

	function htmlEntities3(str) {
	    return String(str).replace(/(\S+)=["']?((?:.(?!["']?\s+(?:\S+)=|[>"']))+.)["']?/g, '')
		.replace(/^<table.*[">$]/g, '<table class="ui celled table">')
		.replace(/<span >/g, '')
		.replace(/<\/span>/g, '')
		.replace(/<td >/g, '<td>')
		.replace(/&nbsp;/g, '')
	//	.replace(//g, '<td>')
	}
*/
var file_upload = new window.service.file_upload.file_upload__single_readAsArrayBuffer();

//--------------------------------------------------function;

file_upload.file_upload_input = "doc_file_upload_input";
file_upload.upload_files = "upload_files";
file_upload.upload_end_cbFuntion = function( d ){
	send_file( d )
}


/**
 * 
*/
var send_file = function( d ){

	var url = "/api/Chat/board/write"

	var _tmp = d.fileNm.split(".")
	var fileExtend = _tmp[ _tmp.length - 1 ].toLowerCase();
	var data = "sid=" + window.service.cookie.getCookie('session')
			+ "&mid=" + window.service.cookie.getCookie('mid')
			+ "&content=" + document.getElementById( "doc_file_textarea" ).value 
			+ "&cd$project=" + current_project__data.cd
			+ "&cd$notebook=" + current_notebook__data.cd
			+ "&cd$doc=" + current_view_doc__data.cd
			+ "&filePath=" + d.ws.path
			+ "&fileNm=" + d.fileNm
			+ "&fileExtend=" + fileExtend
			

	window.service.Request.req_POST_data__Callback(url,encodeURIComponent( data ),function( result ){
		if(result == 0) return window.service.session.remove_deleteCookies_location_login();

		var data = JSON.parse( result );
		console.log( data );
		console.log( "--등록완료--" );
		var sendObj = {}
		sendObj.destination = "chat"
		sendObj.doc_cd = current_view_doc__data.cd
		sendObj.data = result

		current_note_chat__data[ current_view_doc__data.cd ].data.push( JSON.parse( result ) );
		
		connection.send( JSON.stringify( sendObj ) );

		document.getElementById("doc_file_upload_input").value = "";
		document.getElementById("doc_file_textarea").value = "";
		window.service.element.removeChild_all( document.getElementById("upload_files") );
		
		$('#doc_chat_file_add_modal').modal('hide');
	})
}


/**
 * 
*/
var download_doc_chat_file = function( fileNm, filePath, fileExtend ){

	var url = "/api/File/common/download_file_stream?sid=" + window.service.cookie.getCookie('session') 
			+ "&mid=" + window.service.cookie.getCookie('mid')
			+ "&filePath=" + filePath
			+ "&fileExtend=" + fileExtend
			+ "&fileNm=" + fileNm;

	window.location = url;
}

/**
 * 채팅사이드바의 채팅리스트를 그린다.
*/
var render_chat_data = function( arr, cbFunction ){
	var _el = document.getElementById("doc_comment_container");
	
	var url1 = "/api/Render/thtml/include_thtml?sid=" + window.service.cookie.getCookie('session') + "&fileNm=" + "render_chat_data.thtml"
	window.service.Request.req_GET_data__Callback(url1,function(result){
		if(result == 0) return window.service.session.remove_deleteCookies_location_login();
		
		var _template = result;

		var i = 0,iLen = arr.length,io;
		for(;i<iLen;++i)
		{
			io = arr[ i ];
			var broadcast_msg = "";
			var msg = io.content;
			if( msg.indexOf("\n") != -1)
			{
				var _ta = msg.split("\n")
				var j = 0,jLen = _ta.length,jo;
				for(;j<jLen;++j)
				{
					jo = _ta[ j ];
					broadcast_msg += "<p>" + jo + "</p>\n";
				}
			}
			else
			{
				broadcast_msg = "<p>" + msg + "</p>";
			};


			if( io.fileNm != "")
			{
				var fileHtmlSource = "<div class=\"text\"><i class=\"file alternate outline icon\"></i>" + io.fileNm + "</div>"
									+ "<div class=\"actions\"><a class=\"reply\" id=\"comment_file_download_btn\">download</a></div>";
			}
			else
			{
				var fileHtmlSource = "";
			}
			
			
			var html_include_data = _template.replace( "{{image_url}}", io.member.image )
			.replace( "{{author}}", io.member.nm )
			.replace( "{{regist_date}}", window.service.date.make_Array_dateFormat( io.regist_date ) )
			.replace( "{{content}}", broadcast_msg )
			.replace( "{{file}}", fileHtmlSource );
			
			/*
			'beforebegin' element 앞에 
			'afterbegin'element 안에 가장 첫번째 child
			'beforeend' element 안에 가장 마지막 child
			'afterend' element 뒤에
			*/
			_el.insertAdjacentHTML( 'afterbegin', html_include_data );
		}

		cbFunction();
	});
};


/**
 * 각문서의 채팅리스트를 가져온다
*/
var chat_board_get_list = function(){

	var url = "/api/Chat/board/get_list?sid=" + window.service.cookie.getCookie('session') 
			+ "&cd$doc=" + current_view_doc__data.cd
			+ "&limit=" + current_note_chat__data[ current_view_doc__data.cd ].limit
			+ "&skip=" + current_note_chat__data[ current_view_doc__data.cd ].skip;

	window.service.Request.req_GET_data__Callback(url,function(result){
		if(result == 0) window.service.session.remove_deleteCookies_location_login()

		var data = JSON.parse( result );
		
		render_chat_data( data, function(){
			
			var objDiv = document.getElementById("doc_comment_wrap")
			var cur_objDiv_scrollHeight = objDiv.scrollHeight - pre_objDiv_scrollHeight;

			objDiv.scrollTop =  cur_objDiv_scrollHeight;
			pre_objDiv_scrollHeight = objDiv.scrollHeight;
		} );

		var i = 0,iLen = data.length,io;
		for(;i<iLen;++i)
		{
			current_note_chat__data[ current_view_doc__data.cd ].data.push( data[ i ] );
		}
	})
}

/**
 * 
*/
var write_chat = function(){

	var url = "/api/Chat/board/write"

	var data = "sid=" + window.service.cookie.getCookie('session')
			+ "&mid=" + window.service.cookie.getCookie('mid')
			+ "&content=" + document.getElementById( "doc_comment_textarea" ).value 
			+ "&cd$project=" + current_project__data.cd
			+ "&cd$notebook=" + current_notebook__data.cd
			+ "&cd$doc=" + current_view_doc__data.cd
			+ "&filePath=" + ""
			+ "&fileNm=" + ""
			+ "&fileExtend=" + "";

	window.service.Request.req_POST_data__Callback(url,encodeURIComponent( data ),function( result ){
		if(result == 0) return window.service.session.remove_deleteCookies_location_login();

		var data = JSON.parse( result );
		console.log( data );
		console.log( "--등록완료--" );
		var sendObj = {}
		sendObj.destination = "chat"
		sendObj.doc_cd = current_view_doc__data.cd
		sendObj.data = result
		
		current_note_chat__data[ current_view_doc__data.cd ].data.push( JSON.parse( result ) );

		connection.send( JSON.stringify( sendObj ) );
		document.getElementById( "doc_comment_textarea" ).value = "";
	})
}

/**
 *
 */
var btn_control = function( o ){
	var btn_object = { modify : "none", delete : "none", delete : "none", cancel : "none", lists : "none", write : "none"};
	for( var s in btn_object )
	{
		if( o[ s ] ) document.getElementById( s ).style.display = o[ s ];
		else document.getElementById( s ).style.display = btn_object[ s ];
	}
	return;
}

/**
 * 
 */
var project_sub_nav_sidebar_open = function(){
	$('#project_side_bar')
	.sidebar({context:$('#app')})
	.sidebar('setting', 'transition', 'overlay')
	.sidebar('setting', 'dimPage', true)
	.sidebar('setting', 'closable', false)
	.sidebar('show')
}

/**
 * 
 */

var file_side_bar_open = function(){
	$('#file_side_bar')
	.sidebar({context:$('#app')})
	.sidebar('setting', 'transition', 'overlay')
	.sidebar('setting', 'dimPage', true)
	.sidebar('setting', 'closable', true)
	.sidebar('toggle')
}

/**
 * 
 */
 var project_sub_nav_sidebar_hide = function(){
	$('#project_side_bar')
	.sidebar({context:$('#app')})
	.sidebar('setting', 'transition', 'overlay')
	.sidebar('setting', 'dimPage', true)
	.sidebar('setting', 'closable', false)
	.sidebar('hide')
}

/**
 * 
*/
var notebook_modify = function( d ){
	$('#notebook_add_modal').modal('show');
	console.log("modify_notebook")

	document.getElementById("notebook_add_write_field").style.display = "none";
	document.getElementById("notebook_update_btn_field").style.display = "block";
	document.getElementById("modal_notebook_nm").value = d.nm;
	document.getElementById("modal_notebook_desc").value = d.description;

	document.getElementById("notebook_update_btn").addEventListener("click",function(){
		var _uo;
		_uo = d
		_uo.nm = document.getElementById("modal_notebook_nm").value;
		_uo.description = document.getElementById("modal_notebook_desc").value;
		console.log( _uo )
		
		update_notebook( _uo );
	})
}

/**
 * 
*/
var project_modify = function( d ){
	$('#project_add_modal').modal('show');
	console.log("modify_project")

	document.getElementById("modal_project_header").innerText = "Project Modify."
	document.getElementById("project_add_write_field").style.display = "none";
	document.getElementById("project_update_btn_field").style.display = "block";
	document.getElementById("modal_project_nm").value = d.nm;
	document.getElementById("modal_project_desc").value = d.description;

	current_project__data = d;
}

/**
 * 프로젝트 리스트를 그린다.
*/
var make_project_list = function(){
	
	_el_btn__project_add_write.removeEventListener("click",write_project);

	document.getElementById("app").style.display = "none";

	window.service.element.removeChild_all( document.getElementById( "notebook_list" ));
	window.service.element.removeChild_all( document.getElementById( "sub_list" ));
	window.service.element.removeChild_all( document.getElementById( "view_container" ));

	document.getElementById( "project_list_container" ).setAttribute("style","display : block;")

	var url1 = "/api/Render/thtml/include_thtml?sid=" + window.service.cookie.getCookie('session') + "&fileNm=" + "make_project_list.thtml"
	window.service.Request.req_GET_data__Callback(url1,function(result){
		if(result == 0) return window.service.session.remove_deleteCookies_location_login();
		
		var _template = result;
		
		var url = "/api/Category/project/get_list?sid=" + window.service.cookie.getCookie('session');
		window.service.Request.req_GET_data__Callback(url,function(result){
			if(result == 0) return window.service.session.remove_deleteCookies_location_login();

			var data = JSON.parse( result );

			console.log( data );
			project_list_data = data;


			document.getElementById( "notebook_add_container" ).setAttribute( "style", "display : none;" )
			document.getElementById( "note_add_container" ).setAttribute( "style", "display : none;" )
			window.service.element.removeChild_all( document.getElementById("project_list"))
			window.service.element.removeChild_all( document.getElementById("notebook_list") );

			var i = 0,iLen = data.length,io
			for(;i<iLen; ++i)
			{
				io = data[ i ];
				
				var html_include_data = _template.replace( "{{nm}}", io.nm )
				.replace( "{{description}}", io.description )
				.replace( "{{regist_date}}", window.service.date.make_Array_dateFormat( io.regist_date ) );

				document.getElementById("project_list").insertAdjacentHTML( 'beforeend', html_include_data );
			}

		})

	})
}

/**
 * 노트북 리스트를 만든다.
*/
var make_notebook_list = function( cd$project ){

	_el_btn__notebook_add_write.removeEventListener("click",write_notebook);

	var _t0 = document.getElementById("notebook_list")
	
	if( _t0.firstChild ) while( _t0.firstChild ) _t0.removeChild( _t0.firstChild );

	var url1 = "/api/Render/thtml/include_thtml?sid=" + window.service.cookie.getCookie('session') + "&fileNm=" + "make_notebook_list.thtml"
	window.service.Request.req_GET_data__Callback(url1,function(result){
		if(result == 0) return window.service.session.remove_deleteCookies_location_login();
		
		var _template = result;

		var url = "/api/Category/notebook/get_list?sid=" + window.service.cookie.getCookie('session') + "&cd$project=" + cd$project;
		window.service.Request.req_GET_data__Callback(url,function(result){
			if(result == 0) return window.service.session.remove_deleteCookies_location_login();

			var data = JSON.parse( result );

			notebook_list_data = data;

			//노트북리스트 초기화;
			var _el_div__sub_list = document.getElementById( "sub_list" )
			if( _el_div__sub_list ) if( _el_div__sub_list.firstChild ) while( _el_div__sub_list.firstChild ) _el_div__sub_list.removeChild( _el_div__sub_list.firstChild );
			var _el_div__view_container = document.getElementById( "view_document" )
			if( _el_div__view_container ) if( _el_div__view_container.firstChild ) while( _el_div__view_container.firstChild ) _el_div__view_container.removeChild( _el_div__view_container.firstChild );

			document.getElementById( "notebook_add_container" ).setAttribute( "style", "display : block;" )

			//----- 리스트높이 자동조절;
			var _h = document.body.clientHeight;
			var header_h = document.getElementById("headerContainer").scrollHeight;
			var footer_h = document.getElementById("footer").scrollHeight;
			var notebook_add_h = document.getElementById("notebook_add_container").scrollHeight;
			
			document.getElementById("notebook_list").style.height = _h - notebook_add_h - header_h - footer_h;
			//----- 리스트높이 자동조절;

			window.service.element.removeChild_all( _t0 );

			var i = 0,iLen = data.length,io
			for(;i<iLen; ++i)
			{
				io = data[ i ];
				
				var html_include_data = _template.replace( "{{nm}}", io.nm )
				.replace( "{{description}}", io.description )
				.replace( "{{regist_date}}", window.service.date.make_Array_dateFormat( io.regist_date ) );

				_t0.insertAdjacentHTML( 'beforeend', html_include_data );
			}
			//----------;
			var btn_control_obj = {};
			btn_control( btn_control_obj );
			//----------;

			project_sub_nav_sidebar_open();
		})
	})

	
}

/**
* 리스트의 문서디테일을 가져와 화면에 그린다.
*/
var req_detail_by__id = function( _id ){
	var url = "/api/Board/notice/detail_view_by__id?sid=" + window.service.cookie.getCookie('session') + "&_id=" + _id
	if( document.getElementById('add_doc_con') ) _el_div__view_container.removeChild( document.getElementById('add_doc_con') );

	var url1 = "/api/Render/thtml/include_thtml?sid=" + window.service.cookie.getCookie('session') + "&fileNm=" + "req_detail_by__id.thtml"
	window.service.Request.req_GET_data__Callback(url1,function(result){
		if(result == 0) return window.service.session.remove_deleteCookies_location_login();
		
		var _template = result;

		window.service.Request.req_GET_data__Callback(url,function(result){

			if(result == 0) return window.service.session.remove_deleteCookies_location_login();
			var data = JSON.parse( result );

			current_view_doc__data = data[ 0 ];

			if( document.getElementById("view_document") ) _el_div__view_container.removeChild( document.getElementById("view_document") );

			var html_include_data = _template.replace("{{title}}",data[ 0 ].title)
			.replace("{{date}}",window.service.date.make_Array_dateFormat( data[ 0 ].regist_date ) )
			.replace("{{content}}",data[ 0 ].content);

			_el_div__view_container.innerHTML = html_include_data;

			//make_brcm_3();//breadScrumb 만든다;

			if( document.getElementById('add_doc_con') ) document.getElementById("view_container").removeChild(document.getElementById("add_doc_con"));

			//---------- Button;
			var btn_control_obj = {modify : "block", delete : "block"};
			btn_control( btn_control_obj );
			//---------- Button;

			current_note_chat__data[ current_view_doc__data.cd ] = { data : [], limit : 20, skip : 0 };

			document.getElementById("doc_comment_wrap").setAttribute("style","background-color : #fff;;min-height : 630px;max-height : 630px; height:630px;overflow-y : auto;")
			pre_objDiv_scrollHeight = 0
			
			window.service.element.removeChild_all( _el_div__doc_comment_container );
			
			chat_board_get_list();
			//button 이벤트 연결;
			document.getElementById("modify").removeEventListener( "click",update_doc )
			document.getElementById("modify").addEventListener( "click",modify_doc )
			document.getElementById("delete").addEventListener( "click",function(){
				console.log("asdfasdfasdfasdfasdf")
				delete_doc( current_view_doc__data._id )
			} )
		})
	})
}

/**
 * 서브리스트를 만드는 함수
 * @return {[type]} [description]
 */
var make_sub_list = function( cd$notebook ){

	//----- 리스트높이 자동조절;
	var _h = document.body.clientHeight;
	var header_h = document.getElementById("headerContainer").scrollHeight;
	var footer_h = document.getElementById("footer").scrollHeight;
	var note_add_h = document.getElementById("note_add_container").scrollHeight;
	document.getElementById("pusher_container").style.display = "block";
	document.getElementById("sub_list").style.height = _h - note_add_h - header_h - footer_h;
	//----- 리스트높이 자동조절;

	var url1 = "/api/Render/thtml/include_thtml?sid=" + window.service.cookie.getCookie('session') + "&fileNm=" + "make_sub_list.thtml"
	window.service.Request.req_GET_data__Callback(url1,function(result){
		if(result == 0) return window.service.session.remove_deleteCookies_location_login();
		
		var _template = result;

		var url = "/api/Board/notice/get_list?sid=" + window.service.cookie.getCookie('session') + "&cd$notebook=" + cd$notebook;
		window.service.Request.req_GET_data__Callback(url,function(result){
			if(result == 0) return window.service.session.remove_deleteCookies_location_login();

			var data = JSON.parse( result )

			_el_div__sub_list.innerHTML = "";//dom 초기화;

			var regex = /(&nbsp;|<([^>]+)>)/ig

			var i = 0,iLen = data.length,io;
			for(; i<iLen; ++i ){

				io = data[ i ];

				var html_include_data = _template.replace( "{{title}}", io.title )
				.replace( "{{regist_date}}", window.service.date.make_Array_dateFormat( io.regist_date ) )
				.replace("{{content}}", io.content.replace(regex, "").substr(0, 50) );

				_el_div__sub_list.insertAdjacentHTML( 'beforeend', html_include_data );
			}
			document.getElementById( "note_add_container" ).setAttribute( "style", "display : block;" )
			notebook_detail_data = data;

		})

	})
}

/**
 * 프로젝트를 등록한다.
*/
var write_project = function(){

	var project_nm =  document.getElementById("modal_project_nm").value;
	var project_desc = document.getElementById("modal_project_desc").value;

	var url = "/api/Category/project/write?sid=" + window.service.cookie.getCookie('session')
			+ "&project_nm=" + project_nm
			+ "&project_desc=" + project_desc

	window.service.Request.req_GET_data__Callback(url,function(result){
		if(result == 0){
			window.service.session.remove_deleteCookies()
			location.href = "/Member/login";
		}
		var data = JSON.parse( result );

		document.getElementById( "modal_project_nm" ).value = "";
		document.getElementById( "modal_project_desc" ).value = "";
		$('#project_add_modal').modal('hide');

		current_project__data = data;

		make_project_list();
	})
}

/**
 * 노트북을 등록한다.
*/
var write_notebook = function(){

	var notebook_nm =  document.getElementById("modal_notebook_nm").value;
	var notebook_desc = document.getElementById("modal_notebook_desc").value;

	var url = "/api/Category/notebook/write?sid=" + window.service.cookie.getCookie('session')
			+ "&notebook_nm=" + notebook_nm
			+ "&notebook_desc=" + notebook_desc
			+ "&cd$project=" + current_project__data.cd
			+ "&nm$project=" + current_project__data.nm

	window.service.Request.req_GET_data__Callback(url,function(result){
		if(result == 0){
			window.service.session.remove_deleteCookies()
			location.href = "/Member/login";
		}
		var data = JSON.parse( result );

		document.getElementById( "modal_notebook_nm" ).value = "";
		document.getElementById( "modal_notebook_desc" ).value = "";
		$('#notebook_add_modal').modal('hide');

		make_notebook_list( current_project__data.cd );
	})
}

/**
*문서를 등록한다.
*/
var write_doc = function(){

	var url = "/api/Board/notice/write"
	var title = document.getElementById("title").value
	var data = "sid=" + window.service.cookie.getCookie('session')
			+ "&data=" + window.service.render.textarea_html_tag_change( encodeURIComponent( CKEDITOR.instances.editor.getData() ) )
			+ "&title=" + encodeURIComponent( title )
			+ "&cd$project=" + current_project__data.cd
			+ "&cd$notebook=" + current_notebook__data.cd;


	window.service.Request.req_POST_data__Callback(url,encodeURI( data ),function( result ){
		if(result == 0) window.service.session.remove_deleteCookies_location_login()

		var data = JSON.parse( result );
		console.log( data );
		console.log( "--등록완료--" );

		_el_div__view_container.removeChild( document.getElementById('add_doc_con') );

		make_sub_list( current_notebook__data.cd );//서브리스트 갱신;

		req_detail_by__id( data._id );//view 데이터 갱신;
	})
}

/**
 * 등록을 취소한다.
 * @return {[type]} [description]
 */
var write_cancel = function(){

	//Dom 삭제;
	document.getElementById("view_container").removeChild(document.getElementById("add_doc_con"));

	if( current_view_doc__data._id ) req_detail_by__id( current_view_doc__data._id )
	var btn_control_obj = {}
	btn_control( btn_control_obj );
}

/**
 * 문서를 업데이트 한다.
 * @param  {[type]} data [description]
 * @return {[type]}      [description]
 */
var update_doc = function( data ){

	var url = "/api/Board/notice/update"
	var title = document.getElementById("title").value
	var data = "sid=" + window.service.cookie.getCookie('session')
	+ "&_id=" + current_view_doc__data._id
	+ "&data=" + window.service.render.textarea_html_tag_change( encodeURIComponent( CKEDITOR.instances.editor.getData() ) )
	+ "&title=" + encodeURIComponent( title );

	window.service.Request.req_POST_data__Callback(url,encodeURI( data ),function( result){
		if(result == 0){
			window.service.session.remove_deleteCookies()
			location.href = "/Member/login";
		}
		var data = JSON.parse( result );

		console.log( data );
		console.log( "--수정완료--" )

		document.getElementById("view_container").removeChild(document.getElementById("add_doc_con"));

		make_sub_list( current_notebook__data.cd );
		req_detail_by__id( data )
	})
}

/**
 * 
*/

var update_project = function( d ){

	var url = "/api/Category/project/update"
	var data = "sid=" + window.service.cookie.getCookie('session')
	+ "&_id=" + d._id
	+ "&description=" + window.service.render.textarea_html_tag_change( encodeURIComponent( d.description ) )
	+ "&nm=" + encodeURIComponent( d.nm );

	window.service.Request.req_POST_data__Callback(url,encodeURI( data ),function( result){
		if(result == 0) return window.service.session.remove_deleteCookies_location_login();
		var data = JSON.parse( result );

		console.log( data );
		console.log( "--수정완료--" )
		$('#project_add_modal').modal('toggle');
		make_project_list();

	})
}

/**
 * 
*/

var update_notebook = function( d ){

	var url = "/api/Category/notebook/update"
	var data = "sid=" + window.service.cookie.getCookie('session')
	+ "&_id=" + d._id
	+ "&description=" + window.service.render.textarea_html_tag_change( encodeURIComponent( d.description ) )
	+ "&nm=" + encodeURIComponent( d.nm );

	window.service.Request.req_POST_data__Callback(url,encodeURI( data ),function( result){
		if(result == 0) return window.service.session.remove_deleteCookies_location_login();
		var data = JSON.parse( result );

		console.log( data );
		console.log( "--수정완료--" )
		make_notebook_list( current_project__data.cd )
		$('#notebook_add_modal').modal('toggle');


		current_notebook__data = d

		document.getElementById("note_add_container").setAttribute("style","display : block;")
		document.getElementById("notebook_title").innerText = current_notebook__data.nm
		document.getElementById("notebook_desc").innerText = current_notebook__data.description

		make_sub_list( current_notebook__data.cd );

		var _t0 = document.getElementById( "view_document" )
		if( _t0 ) if( document.getElementById("view_document").firstChild ) while( document.getElementById("view_document").firstChild ) document.getElementById("view_document").removeChild( _t0.firstChild );

		//make_brcm_2();

	})
}

/**
 * 문서 수정폼을 호출한다.
 * @return {[type]} [description]
 */
var modify_doc = function(){

	//수정폼 로드;
	if( document.getElementById( "view_document" ) ) document.getElementById( "view_document" ).setAttribute("style","display : none;");
	window.service.element.removeChild_all( _el_div__view_container );
	//thtml을 호출한다.
	var url1 = "/api/Render/thtml/include_thtml?sid=" + window.service.cookie.getCookie('session') + "&fileNm=" + "add_doc.thtml"
	window.service.Request.req_GET_data__Callback(url1,function(result){
		if(result == 0) return window.service.session.remove_deleteCookies_location_login();

		_el_div__view_container.insertAdjacentHTML( 'beforeend', result );

		//에디터 로드;
		CKEDITOR.replace( 'contents',{
			customConfig : './config.js',
			width: '100%',
			height: '550px',
			toolbarStartupExpanded : false
		});

		//필드초기화;
		document.getElementById("title").value = current_view_doc__data.title;
		CKEDITOR.instances.editor.setData( current_view_doc__data.content );

		//----------;
		var btn_control_obj = {
			modify : "block"
			, cancel : "block"
		}
		btn_control( btn_control_obj );
		//----------;

		document.getElementById("modify").removeEventListener("click",modify_doc)
		document.getElementById("modify").addEventListener("click",update_doc)
		document.getElementById("cancel").addEventListener("click", write_cancel );
	})
}

/**
 * 노트북을 삭제한다.
 * @return {[type]} [description]
 */
 var delete_project = function( notebook_id ){

	var url = "/api/Category/project/delete?sid=" + window.service.cookie.getCookie('session')
	+ "&_id=" + notebook_id

	window.service.Request.req_GET_data__Callback(url,function( result ){
		if(result == 0) return window.service.session.remove_deleteCookies_location_login();

		console.log( result );
		console.log( "--삭제완료--" )
		
		make_project_list()
	})
}

/**
 * 노트북을 삭제한다.
 * @return {[type]} [description]
 */
var delete_notebook = function( notebook_id ){

	var url = "/api/Category/notebook/delete?sid=" + window.service.cookie.getCookie('session')
	+ "&_id=" + notebook_id

	window.service.Request.req_GET_data__Callback(url,function( result ){
		if(result == 0) return window.service.session.remove_deleteCookies_location_login();

		console.log( result );
		console.log( "--삭제완료--" )

		make_notebook_list( current_project__data.cd )
	})
}



var delete_doc = function( doc_id ){

	var url = "/api/Board/notice/delete?sid=" + window.service.cookie.getCookie('session')
	+ "&_id=" + doc_id

	window.service.Request.req_GET_data__Callback(url,function( result ){
		if(result == 0){
			window.service.session.remove_deleteCookies()
			location.href = "/Member/login";
		}
		console.log( result );
		console.log( "--삭제완료--" )

		make_sub_list( current_notebook__data.cd );
		if( document.getElementById("view_document") ) document.getElementById("view_container").removeChild(document.getElementById("view_document"));
	
		//----------;
		var btn_control_obj = {add : "block"}
		btn_control( btn_control_obj );
		//----------;
		/*
		$('#app .ui.sidebar').sidebar('is open');
		$('#app .ui.sidebar').sidebar('is closed');
		$('#app .ui.sidebar').sidebar('is visible');
		$('#app .ui.sidebar').sidebar('is hidden');
		*/
		
		if( $('#app .ui.sidebar').sidebar('is hidden') ) project_sub_nav_sidebar_open();

		document.getElementById("note_add").addEventListener("click", add_doc );
	
	})
}

/**
* !문서등록폼을 호출한다.
*/

var add_doc = function(){

	$('#app .ui.sidebar').sidebar({context:$('#app')}).sidebar('setting', 'transition', 'push').sidebar('setting', 'dimPage', false).sidebar('hide')

	if( document.getElementById( "view_document" ) ) document.getElementById( "view_document" ).setAttribute("style","display : none;");
	
	//thtml을 호출한다.
	var url1 = "/api/Render/thtml/include_thtml?sid=" + window.service.cookie.getCookie('session') + "&fileNm=" + "add_doc.thtml"
	window.service.Request.req_GET_data__Callback(url1,function(result){
		if(result == 0) return window.service.session.remove_deleteCookies_location_login();
		/*
		var markup = '<div><p>text here</p></div>';
		var parser = new DOMParser()
		var el = parser.parseFromString(_template, "text/xml");
		*/
		_el_div__view_container.insertAdjacentHTML( 'beforeend', result );

		//에디터 로드;
		CKEDITOR.replace( 'contents',{
			customConfig : './config.js',
			width: '100%',
			height: '600px',
			toolbarStartupExpanded : false
		});

		//필드초기화;
		document.getElementById("title").value = "";
		CKEDITOR.instances.editor.setData("내용을 입력해주세요")

		//----------;
		var btn_control_obj = {cancel : "block", write : "block"}
		btn_control( btn_control_obj );
		//----------;

		document.getElementById("write").addEventListener("click",write_doc)
		document.getElementById("cancel").addEventListener("click", write_cancel );

	})
}

//--------------------------------------------------function;

//------------------------------ event;
_el_btn__doc_comment_send_btn.addEventListener("click",write_chat);

document.getElementById("doc_comment_wrap").addEventListener("scroll",function(){
	var doc_comment_wrap = document.getElementById("doc_comment_wrap");
	if( doc_comment_wrap.scrollTop == 0 )
	{
		current_note_chat__data[ current_view_doc__data.cd ].skip += 20
		chat_board_get_list()
	}
})


document.getElementById("doc_comment_container").addEventListener("click",function(e){
	var pe = e.currentTarget.children
	var te = window.service.element.match_el( e.target, "comment", "doc_comment_container" )

	var i = 0,iLen = pe.length,io;
	for(;i < iLen;++i){
		io = pe[ i ]
		if( io == te )
		{
			console.log( i )
			if( window.service.element.match_el(e.target,"comment_file_download_btn","comment").id == "comment_file_download_btn")
			{
				var _to = current_note_chat__data[ current_view_doc__data.cd ].data;
				var data_len = _to.length -1;
				var data_index = data_len - i;
				
				console.log( "comment_file_download_btn" )
				console.log( _to[ data_index ].fileNm )
				console.log( _to[ data_index ].filePath )
				download_doc_chat_file( _to[ data_index ].fileNm, _to[ data_index ].filePath, _to[ data_index ].fileExtend );			
				return;
			}	
		}
	}
})


_el_div__notebook_list.addEventListener("click",function(e){

	var pe = e.currentTarget.children
	var te = window.service.element.match_el( e.target, "notebook_list_item", "notebook_list" )

	var i = 0,iLen = pe.length,io;
	for(;i < iLen;++i){
		io = pe[ i ]
		if( io == te )
		{
			console.log( i )
			if( window.service.element.match_el(e.target,"notebook_list_delete_btn","notebook_list_item").id == "notebook_list_delete_btn")
			{
				console.log('notebook_list_delete_btn')
				delete_notebook( notebook_list_data[ i ]._id )

				document.getElementById("note_add_container").setAttribute("style","display : none;")
				document.getElementById("notebook_title").innerText = "";

				document.getElementById("project_list_container").style.display ="none";
				document.getElementById("app").style.display = "block";
				make_notebook_list( current_project__data.cd );
				
				return;
			}
			else if( window.service.element.match_el(e.target,"notebook_list_modify_btn","notebook_list_item").id == "notebook_list_modify_btn")
			{
				console.log('notebook_list_modify_btn')
				notebook_modify( notebook_list_data[ i ] )
				return;
			}		
			else
			{
				current_notebook__data = notebook_list_data[ i ]

				document.getElementById("note_add_container").setAttribute("style","display : block;")
				document.getElementById("notebook_title").innerText = current_notebook__data.nm
				document.getElementById("notebook_desc").innerText = current_notebook__data.description

				make_sub_list( current_notebook__data.cd );

				var _t0 = document.getElementById( "view_document" )
				if( _t0 )
				{
					if( document.getElementById("view_document").firstChild )
					{
						while( document.getElementById("view_document").firstChild )
						{
							document.getElementById("view_document").removeChild( _t0.firstChild );
						}
					}
				}
				
				project_sub_nav_sidebar_hide();
				//make_brcm_2();
			}
		}
	}
	//----------;
	var btn_control_obj = {};
	btn_control( btn_control_obj );
	//----------;
})

_el_btn__project_update_btn.addEventListener("click",function(){
	var _uo;
	_uo = current_project__data
	_uo.nm = document.getElementById("modal_project_nm").value;
	_uo.description = document.getElementById("modal_project_desc").value;
	console.log( _uo )
	
	update_project( _uo );
})

_el_btn__notebook_title_modify_btn.addEventListener("click",function(){
	notebook_modify( current_notebook__data )
})

_el_btn__notebook_add_cancel.addEventListener("click",function(){
	document.getElementById( "modal_notebook_nm" ).value = "";
	document.getElementById( "modal_notebook_desc" ).value = "";
	document.getElementById("notebook_add_write_field").style.display = "block";
	document.getElementById("notebook_update_btn_field").style.display = "none";

	$('#notebook_add_modal').modal('hide');
})

_el_btn__project_add_cancel.addEventListener("click",function(){
	document.getElementById( "modal_project_nm" ).value = "";
	document.getElementById( "modal_project_desc" ).value = "";
	$('#project_add_modal').modal('hide');
})

_el_btn__notebook_add.addEventListener("click",function(){
	$('#notebook_add_modal').modal('toggle');
	console.log("_el_btn__project_add")
	document.getElementById( "modal_notebook_nm" ).value = "";
	document.getElementById( "modal_notebook_desc" ).value = "";
	document.getElementById("notebook_add_write_field").style.display = "block";
	document.getElementById("notebook_update_btn_field").style.display = "none";

	_el_btn__notebook_add_write.addEventListener("click",write_notebook );
})

_el_btn__doc_chat_file_add_btn.addEventListener("click", function(){
	document.getElementById("doc_file_textarea").value = "";
	file_upload.initailize();
	$('#doc_chat_file_add_modal').modal('show',function(){
		file_upload.addEvent( el_doc_chat__file_input, el_doc_chat__file_button);
	});
})

_el_div__project_list.addEventListener("click",function(e){

	var pe = e.currentTarget.children
	var te = window.service.element.match_el( e.target, "project_list_card", "project_list_container" )

	var i = 0,iLen = pe.length,io;
	for(;i < iLen;++i){
		io = pe[ i ]
		if( io == te )
		{
			console.log( i )
			if( window.service.element.match_el(e.target,"project_list_delete_btn","project_list_card").id == "project_list_delete_btn")
			{
				console.log( i )
				console.log('project_list_delete_btn')
				delete_project( project_list_data[ i ]._id )

				return;
			}
			else if( window.service.element.match_el(e.target,"project_list_modify_btn","project_list_card").id == "project_list_modify_btn")
			{
				console.log( i )
				console.log('project_list_delete_btn')
				project_modify( project_list_data[ i ] )

				return;
			}	
			else
			{
			console.log( i )
				document.getElementById("note_add_container").setAttribute("style","display : none;")
				document.getElementById("notebook_title").innerText = "";


				current_project__data = project_list_data[ i ];
				document.getElementById( "project_title" ).innerText = current_project__data.nm
				document.getElementById( "project_desc" ).innerText = current_project__data.description
				document.getElementById("project_list_container").style.display ="none";
				document.getElementById("app").style.display = "block";
				make_notebook_list( current_project__data.cd );

				return;
			}
		}
	}
	//----------;
	var btn_control_obj = {};
	btn_control( btn_control_obj );
	//----------;
})

_el_btn__project_list_view_btn.addEventListener("click",function(){
	document.getElementById("app").style.display = "none";
	make_project_list();
})

_el_div__sub_list.addEventListener("click", function(e){
	var pe = e.currentTarget.children
	var te = window.service.element.match_el( e.target, "list", "sub_list" )

	var i = 0,iLen = pe.length,io;
	for(;i < iLen;++i){
		io = pe[ i ]
		if( io == te ){
			console.log( i )
			if( window.service.element.match_el(e.target,"sub_list_delete_btn","list").id == "sub_list_delete_btn")
			{
				console.log('sub_list_delete_btn')
				delete_doc( notebook_detail_data[ i ]._id )
				make_sub_list( current_notebook__data.cd );

				var _t0 = document.getElementById( "view_document" )
				if( _t0 )
				{
					if( document.getElementById("view_document").firstChild )
					{
						while( document.getElementById("view_document").firstChild )
						{
							document.getElementById("view_document").removeChild( _t0.firstChild );
						}
					}
				}
				return;
			}
			else if( window.service.element.match_el(e.target,"sub_list_modify_btn","list").id == "sub_list_modify_btn")
			{
				console.log('sub_list_modify_btn')
				current_view_doc__data = notebook_detail_data[ i ]
				modify_doc()
				return;
			}
			else if( window.service.element.match_el(e.target,"file_side_bar_open_btn","list").id == "file_side_bar_open_btn")
			{
				console.log('file_side_bar_open_btn')
				file_side_bar_open();
				return;
			}
			else
			{
				return req_detail_by__id( notebook_detail_data[ i ]._id )
			}
		}
	}
})

//------------------------------ addEventListener;

/**
 * 페이지 초기화;
 * @return {[type]} [description]
 */
var Initialize = function(){

	make_project_list();
	//----------;
	var btn_control_obj = {add : "block"}
	btn_control( btn_control_obj );
	//----------;
	document.getElementById("note_add").addEventListener("click", add_doc );
}

Initialize();

</script>
