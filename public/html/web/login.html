<style type="text/css">
body {
	background-color: #ffffff !important;
}
body > .grid {
	height: 100%;
}
.image {
	margin-top: -100px;
}
.column {
	max-width: 450px;
}
</style>

<script>
//569461541815-9pqrabnuovhsa493fhp1v11nb9q53sl9.apps.googleusercontent.com
//24YPRuDtSWf2oo29PzRu7-8q
  var YOUR_CLIENT_ID = '569461541815-9pqrabnuovhsa493fhp1v11nb9q53sl9.apps.googleusercontent.com';
  var YOUR_REDIRECT_URI = 'http://ec2-13-125-22-207.ap-northeast-2.compute.amazonaws.com:8888/auth2callback';
  var queryString = location.hash.substring(1);

  // Parse query string to see if page request is coming from OAuth 2.0 server.
  var params = {};
  var regex = /([^&=]+)=([^&]*)/g, m;
  while (m = regex.exec(queryString)) {
    params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
    // Try to exchange the param values for an access token.
    exchangeOAuth2Token(params);
  }

  // If there's an access token, try an API request.
  // Otherwise, start OAuth 2.0 flow.
  function trySampleRequest() {
    var params = JSON.parse(localStorage.getItem('oauth2-test-params'));
    debugger;
	if (params && params['access_token']) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET',
          'https://www.googleapis.com/drive/v3/about?fields=user&' +
          'access_token=' + params['access_token']);
      xhr.onreadystatechange = function (e) {
        console.log(xhr.response);
      };
      xhr.send(null);
    } else {
      oauth2SignIn();
    }
  }

  /*
   * Create form to request access token from Google's OAuth 2.0 server.
   */
  function oauth2SignIn() {
    // Google's OAuth 2.0 endpoint for requesting an access token
    var oauth2Endpoint = 'https://accounts.google.com/o/oauth2/v2/auth';

    // Create element to open OAuth 2.0 endpoint in new window.
    var form = document.createElement('form');
    form.setAttribute('method', 'GET'); // Send as a GET request.
    form.setAttribute('action', oauth2Endpoint);

    // Parameters to pass to OAuth 2.0 endpoint.
    var params = {'client_id': YOUR_CLIENT_ID,
                  'redirect_uri': YOUR_REDIRECT_URI,
                  'scope': 'https://www.googleapis.com/auth/drive.metadata.readonly',
                  'state': 'try_sample_request',
                  'include_granted_scopes': 'true',
                  'response_type': 'token'};

    // Add form parameters as hidden input values.
    for (var p in params) {
      var input = document.createElement('input');
      input.setAttribute('type', 'hidden');
      input.setAttribute('name', p);
      input.setAttribute('value', params[p]);
      form.appendChild(input);
    }

    // Add form to page and submit it to open the OAuth 2.0 endpoint.
    document.body.appendChild(form);
    form.submit();
  }

  /* Verify the access token received on the query string. */
  function exchangeOAuth2Token(params) {
    var oauth2Endpoint = 'https://www.googleapis.com/oauth2/v3/tokeninfo';
    if (params['access_token']) {
      var xhr = new XMLHttpRequest();
      xhr.open('POST', oauth2Endpoint + '?access_token=' + params['access_token']);
      xhr.onreadystatechange = function (e) {
        var response = JSON.parse(xhr.response);
        // When request is finished, verify that the 'aud' property in the
        // response matches YOUR_CLIENT_ID.
        if (xhr.readyState == 4 &&
            xhr.status == 200 &&
            response['aud'] &&
            response['aud'] == YOUR_CLIENT_ID) {
          // Store granted scopes in local storage to facilitate
          // incremental authorization.
          params['scope'] = response['scope'];
          localStorage.setItem('oauth2-test-params', JSON.stringify(params) );
          if (params['state'] == 'try_sample_request') {
            trySampleRequest();
          }
        } else if (xhr.readyState == 4) {
          console.log('There was an error processing the token, another ' +
                      'response was returned, or the token was invalid.')
        }
      };
      xhr.send(null);
    }
  }


function oauth_google_get_token(){
	//569461541815-9pqrabnuovhsa493fhp1v11nb9q53sl9.apps.googleusercontent.com
	//24YPRuDtSWf2oo29PzRu7-8q
var clientID ="569461541815-9pqrabnuovhsa493fhp1v11nb9q53sl9.apps.googleusercontent.com";

var authorizationUrlBase="https://accounts.google.com/o/oauth2/auth";

var redirectUri='http://ec2-13-125-22-207.ap-northeast-2.compute.amazonaws.com:8888/auth2callback';

var scope1='https://www.googleapis.com/auth/calendar ';     //캘린더 접근 및 수정 권한 요청
var scope2='https://www.googleapis.com/auth/userinfo.profile ';     //유저 데이터 열람 요청
var scope3='http://www.google.com/m8/feeds/ ';
var scope4='https://www.googleapis.com/auth/userinfo.email '   //유저 이메일 주소 열람 요청
var scope5='https://mail.google.com/'   //유저 이메일 주소 열람 요청

var state=Math.random()*new Date().getTime();

var url=authorizationUrlBase;

url+='?response_type=token'
	+'&redirect_uri='+encodeURIComponent(redirectUri)
	+'&client_id='+encodeURIComponent(clientID)
	+'&scope='+encodeURIComponent(scope2)+encodeURIComponent(scope1)+encodeURIComponent(scope3)+encodeURIComponent(scope4)+encodeURIComponent(scope5)
	+'&approval_prompt=force'
	+'&state='+encodeURIComponent(state);


location.href=url;
//window.service.Request.req_GET_data__Callback(aaa, function(r){
//console.log(r )
//})

//https://www.googleapis.com/plus/v1/people/101042294300396860652?access_token=ya29.GlvuBER26Yh67YPLdEgTgKGO3RGVMlOodBGQhftseup0EBZaYaqfDjylhzxoZIxSbgset1WTbUgeB7oA4QhEWOTBhQhxq1ApGy56INhPuClg3oJ_Cg0kCbLmgGzr
//https://www.googleapis.com/drive/v2/files?&access_token=ya29.GlvuBAUN_qm8VEelkkNkVuBIIc0qpAi-uXY6XzUM7pVhPShFJkVBgY4Tmzb_K_FRZ7Ir_ZnjgZBZxORUQDjVBy2nsUeetY3B5pd1BEyXKrsA5k2jZfRMhFbxe7CH

}

</script>

<include>_header_info.html</include>
<div class="ui middle aligned center aligned grid">
	<div class="column">
		<form class="ui large form">
			<!-- 		<div class="ui segment"> -->
			<div class="field">
				<div class="ui left icon input">
					<i class="user icon"></i>
					<input type="text" name="email" placeholder="E-mail address" id="id" value="csj6311@naver.com">
				</div>
			</div>
			<div class="field">
				<div class="ui left icon input">
					<i class="lock icon"></i>
					<input type="password" name="password" placeholder="Password"id="pwd" value="a">
				</div>
			</div>
			<!-- 		</div> -->
			<div class="ui error message"></div>
		</form>
		<p class="ui"><div class="ui fluid large grey button" id="login_btn">Login</div></p>
		<p class="ui"><div onclick="oauth2SignIn();" class="ui fluid google large button red ">
			<i class="google icon "></i>Google Login</div>
		</p>
		<div class="ui message">
			New to us? <a href="./sign_up">Sign Up</a>
		</div>
	</div>
</div>

<include>_footer_info.html</include>


<script>


var check_login = function(){

	var p0 = document.getElementById("id").value;
	var p1 = document.getElementById("pwd").value;

	var url = "/api/login_check?"
		+ "id=" + p0
		+ "&pwd=" + p1;

	window.service.Request.req_GET_data__Callback( url, function( r ){

	console.log( r )
	var _res_Object = JSON.parse( r )

	if( r != 0 ){
		window.service.session.setSession( _res_Object.sid )
		window.service.cookie.setCookie( "mid", _res_Object.id, 1000*60*15 )
		window.service.cookie.setCookie( "sid_type", "original", 1000*60*15 )
		location.href = "/"
	}
})

};

document.getElementById("login_btn").addEventListener('click', function(){ check_login() })
</script>
